# Send Reports: log exact email/SMS failure reason in column D

## Summary
The `Send Reports` flow writes a log row into the `sentEmails` and `sentTexts` sheets each time an email/SMS is attempted.

Previously:
- Email failures were logged with a hard-coded message in column D (`EMAIL ERROR - NOT SENT`).
- SMS failures were logged with a *cleaned* / generalized message.
- Long messages could be hard to read because wrap was not explicitly enabled.

Now:
- Column D logs the exact error message returned by the underlying failure (email exception message, or SMS provider `error_code`/`error_message`).
- The appended log row (columns A–D) is explicitly set to `wrap`.

## Files changed
- `reports/sendReports/start/sendStudentReport.js`
- `reports/sharedFunctions/init.js`

## Implementation details
### Email (`sentEmails` sheet)
- In the `MailApp.sendEmail(...)` catch handler, we now capture the exception message:
  - `const exactEmailError = (emailErr && emailErr.message) ? String(emailErr.message) : String(emailErr);`
- The appended row for failures is now:
  - `[dateTime, studentName, recipientEmail, exactEmailError]`
- After appending, we set formatting on the new row:
  - red background (`setBackgroundRGB(244, 67, 54)`) like before
  - enable wrapping for the full row range A–D (`getRange(lastRow, 1, 1, 4).setWrap(true)`)

### SMS (`sentTexts` sheet)
- When the SMS provider returns a non-success status, we now log the provider-returned values directly:
  - `error_code` + `error_message` are combined as:
    - `Error <code>: <message>`
  - If the code is missing, we log just the raw message.
- In the `catch (e)` handler (unexpected runtime errors), we log:
  - `e.message` (or `String(e)` as fallback)
- Before writing to the sheet, the error message is redacted to avoid leaking provider account identifiers (e.g., `/Accounts/<...>`).
- After appending, we set formatting on the new row:
  - red background for failures
  - enable wrapping for the full row range A–D

## Preflight quota / credits reminder (Send Reports)
Send Reports now performs a server-side preflight check before sending (user-context only):
- **Emails**: planned email count vs `MailApp.getRemainingDailyQuota()` when available, otherwise vs the fallback from `getDailyRemainingEmails()` / configured quota
- **SMS**: planned SMS count vs `config.global.license.remainingTextMessages`

Planned recipient counts only include non-empty email addresses / phone numbers (and SMS numbers are validated when the filter helper is available) to reduce false reminders.

If planned sends exceed remaining quota/credits, the operation returns a unified response with:
- `status: 'reminder'`
- `warningDetails.reminderDisplay`: a structured reminder card showing a planned vs remaining table

### Where the Continue/Cancel modal comes from
This reuses the existing reminder modal pipeline:
- Server constructs `reminderDisplay` and returns `status: 'reminder'`.
- Client (`client/scripts.html`) detects `status === 'reminder'` and calls `ModalManager.showReminder(...)`.
- On **Continue**, the client sets a continuation flag and re-runs the operation with the same `operationId`.

### Implementation notes
- The preflight check is implemented in `reports/sharedFunctions/init.js` inside `initializeReportExecution(...)`.
- The reminder UI content is generated by `createSendReportsQuotaReminder(...)`.
- The Continue behavior uses a separate `skipSendReportsQuotaCheck_<operationId>` continuation flag so it does not interfere with the zero-weight reminder.

## Drive quota / rate limit errors during Send Reports
Some send failures are not caused by `MailApp.sendEmail(...)` itself, but by the Drive/Docs work required to generate the PDF attachment.

### Symptom
- Error log may show: `Exception: Limit Exceeded: Drive.`
- This can occur during per-student report generation (copying the template, opening/saving the doc, exporting to PDF).

### Impact (before mitigation)
- Because report generation happens before `MailApp.sendEmail(...)`, a Drive quota exception could abort the entire send run mid-stream (some earlier students send successfully, then the run stops).

### Mitigation
- `sendStudentReport.js` now retries report generation a few times (exponential backoff) when the exception looks like a Drive limit error.
- If it still fails, the error is logged to `sentEmails` column D for each intended recipient for that student, and the send continues to the next student.

### Likely causes
- Large batches (many students) generating many Docs/PDFs in one execution.
- Drive/Docs per-minute quotas / transient backend throttling.
- Concurrent Send Reports executions (multiple tabs/users) against the same script/user.

## Notes / behavior
- For email/SMS send attempts themselves, this change is intentionally *logging-focused*: it does not change whether a given `MailApp.sendEmail(...)`/SMS call is attempted or not; it only makes the failure reason visible to the teacher in the log sheets. The Drive quota mitigation above is the only behavioral change (retrying report generation and, on persistent failure, logging the error and continuing to the next student).
- Exact error strings originate from Google Apps Script (`MailApp`) and the SMS provider API, so they may vary depending on the underlying cause.
